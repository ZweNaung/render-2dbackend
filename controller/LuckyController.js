require('dotenv').config();const luckyModel = require("../model/luckyModel");const {PutObjectCommand, S3Client, DeleteObjectCommand} = require('@aws-sdk/client-s3');// R2 (S3) Client Setupconst s3Client = new S3Client({    region: "auto",    endpoint: process.env.R2_ENDPOINT,    credentials: {        accessKeyId: process.env.R2_ACCESS_KEY_ID,        secretAccessKey: process.env.R2_SECRET_ACCESS_KEY,    }})//----- Upload (Overwrite Strategy) ----const luckyUpload = async (req, res) => {    try {        const { name, section } = req.body;        // 1. Validation        if (!name || !section || !req.file) {            return res.status(400).json({ error: "Missing required fields: name, section, or image" });        }        if (!['week', 'day'].includes(section)) {            return res.status(400).json({ error: "Invalid section. Must be 'week' or 'day'." });        }        // 2. Check Existing Data        const existingData = await luckyModel.findOne({ section: section });        // 3. Upload New Image to R2        const fileName = `lucky/${Date.now()}-${req.file.originalname}`;        const command = new PutObjectCommand({            Bucket: process.env.R2_BUCKET_NAME,            Key: fileName,            Body: req.file.buffer,            ContentType: req.file.mimetype,        })        await s3Client.send(command);        const publicUrl = `${process.env.R2_PUBLIC_DOMAIN}/${fileName}`;        // 4. Logic: Replace or Create        if (existingData) {            // Delete Old Image from R2            if (existingData.imgUrl) {                try {                    const urlParts = existingData.imgUrl.split("/");                    if(urlParts.length > 1){                        const oldFileName = urlParts.slice(-2).join('/');                        const deleteCommand = new DeleteObjectCommand({                            Bucket: process.env.R2_BUCKET_NAME,                            Key: oldFileName,                        });                        await s3Client.send(deleteCommand);                    }                } catch (err) {                    console.error("Warning: Failed to delete old image:", err.message);                }            }            // Update Database            existingData.name = name;            existingData.imgUrl = publicUrl;            const updatedData = await existingData.save();            return res.status(200).json({                success: true,                message: `Successfully Updated '${section}' Data`,                data: updatedData,            });        } else {            const newLuckyData = new luckyModel({                name: name,                imgUrl: publicUrl,                section: section            })            const saveData = await newLuckyData.save();            return res.status(201).json({                success: true,                message: `Successfully Created '${section}' Data`,                data: saveData,            });        }    } catch (err) {        console.error("Server Error:", err);        res.status(500).json({ error: "An error occurred on the server." });    }}//----- Get All (With Filter) ----const getAllLucky = async (req, res) => {    try {        const { section } = req.query;        const filter = section ? { section: section } : {};        const allLucky = await luckyModel.find(filter);        res.status(200).json({            success: true,            message: 'Fetch Data Successfully',            data: allLucky        })    } catch (err) {        console.error(err);        res.status(500).json({ error: "An error occurred while fetching data." });    }}//----- Delete ----const deleteLucky = async (req, res) => {    try {        const { id } = req.params;        const luckyToDelete = await luckyModel.findById(id);        if (!luckyToDelete) { return res.status(404).json({ error: "Data Not Found" }) }        if (luckyToDelete.imgUrl) {            const urlParts = luckyToDelete.imgUrl.split("/")            const fileName = urlParts.slice(-2).join('/');            const command = new DeleteObjectCommand({                Bucket: process.env.R2_BUCKET_NAME,                Key: fileName,            })            await s3Client.send(command)        }        await luckyModel.findByIdAndDelete(id)        res.status(200).json({            success: true,            message: 'Successfully Deleted',            data: {                _id: luckyToDelete.id,                name: luckyToDelete.name            },        })    } catch (err) {        console.error(err);        res.status(500).json({ error: "An error occurred while deleting data." });    }}module.exports = {    luckyUpload,    getAllLucky,    deleteLucky}